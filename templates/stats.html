{% extends "base.html" %}

{% block title %}Spaced Repetition Stats{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/stats.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/dark-mode.css') }}">
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div class="d-flex align-items-center gap-3">
        <a href="{{ url_for('deck.get_deck_flashcards', deck_id=deck.flashcard_deck_id) }}" class="btn btn-outline-primary">
            <i class="bi bi-arrow-left"></i> Back to Deck
        </a>
        <h1 class="h2 mb-0">{{ deck.name }} - Spaced Repetition Statistics</h1>
    </div>
</div>

<div class="row g-4">
    <!-- Stats Summary Cards -->
    <div class="col-md-3">
        <div class="stats-card card h-100 shadow-sm bg-primary text-white">
            <div class="card-body">
                <h5 class="card-title"><i class="bi bi-card-list"></i> Total Cards</h5>
                <p class="display-4" id="total-cards">-</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stats-card card h-100 shadow-sm bg-warning text-dark">
            <div class="card-body">
                <h5 class="card-title"><i class="bi bi-clock"></i> Due Today</h5>
                <p class="display-4" id="due-count">-</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stats-card card h-100 shadow-sm bg-success text-white">
            <div class="card-body">
                <h5 class="card-title"><i class="bi bi-graph-up"></i> Retention</h5>
                <p class="display-4" id="retention">-%</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stats-card card h-100 shadow-sm bg-info text-white">
            <div class="card-body">
                <h5 class="card-title"><i class="bi bi-check-circle"></i> Mastered</h5>
                <p class="display-4" id="mastered-count">-</p>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row mt-4">
    <div class="col-md-6">
        <div class="card shadow-sm">
            <div class="card-header bg-light">
                <h5 class="mb-0">Card Status Distribution</h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="stateChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card shadow-sm">
            <div class="card-header bg-light">
                <h5 class="mb-0">Upcoming Reviews</h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="upcomingChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const deckId = {{ deck.flashcard_deck_id }};
    let stateChart, upcomingChart;
    
    async function loadStats() {
        try {
            const response = await fetch(`/flashcard/deck/${deckId}/stats`);
            const stats = await response.json();
            
            console.log("Stats data:", stats); // Debug info
            
            // Update summary cards
            document.getElementById('total-cards').textContent = stats.total_cards;
            document.getElementById('due-count').textContent = stats.due_count;
            document.getElementById('retention').textContent = 
                (stats.average_retention * 100).toFixed(0) + '%';
            document.getElementById('mastered-count').textContent = stats.state_counts.mastered;
            
            // Update charts
            updateStateChart(stats.state_counts);
            updateUpcomingChart(stats.upcoming_reviews);
            
        } catch (error) {
            console.error('Error loading stats:', error);
        }
    }
    
    function updateStateChart(stateCounts) {
        const ctx = document.getElementById('stateChart').getContext('2d');
        
        // Log the state counts for debugging
        console.log("State counts:", stateCounts);
        
        // Ensure we have numeric values for all states (default to 0)
        const data = [
            stateCounts.new || 0, 
            stateCounts.learning || 0,
            stateCounts.mastered || 0,
            stateCounts.forgotten || 0
        ];

        // Use theme-appropriate colors
        const isDarkMode = document.documentElement.getAttribute('data-bs-theme') === 'dark';
        const backgroundColor = [
            '#6c757d',  // New (gray)
            '#ffc107',  // Learning (yellow)
            '#28a745',  // Mastered (green)
            '#dc3545'   // Forgotten (red)
        ];
        
        // Apply different text color based on theme
        const textColor = isDarkMode ? '#e0e0e0' : '#212529';
        
        // If we already have a chart, update it instead of recreating
        if (stateChart) {
            stateChart.data.datasets[0].data = data;
            stateChart.options.plugins.tooltip.bodyColor = textColor;
            stateChart.options.plugins.tooltip.titleColor = textColor;
            stateChart.update();
        } else {
            // Create a new chart
            stateChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['New', 'Learning', 'Mastered', 'Forgotten'],
                    datasets: [{
                        data: data,
                        backgroundColor: backgroundColor,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 1000 // Smoother animation for updates
                    },
                    plugins: {
                        tooltip: {
                            bodyColor: textColor,
                            titleColor: textColor,
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    let value = context.raw || 0;
                                    let total = data.reduce((a, b) => a + b, 0);
                                    let percentage = Math.round((value / total) * 100);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Handle empty data case
        if (data.every(val => val === 0)) {
            ctx.font = '16px Arial';
            ctx.fillStyle = isDarkMode ? '#e0e0e0' : '#666';
            ctx.textAlign = 'center';
            ctx.fillText('No card data available', 
                         ctx.canvas.width / 2, ctx.canvas.height / 2);
        }
    }
    
    function updateUpcomingChart(upcomingReviews) {
        const ctx = document.getElementById('upcomingChart').getContext('2d');
        const labels = [];
        const data = [];
        
        console.log("Upcoming reviews data:", upcomingReviews); // Debug info
        
        // Use theme-appropriate colors
        const isDarkMode = document.documentElement.getAttribute('data-bs-theme') === 'dark';
        const textColor = isDarkMode ? '#e0e0e0' : '#212529';
        const gridColor = isDarkMode ? '#444' : '#ddd';
        
        if (!upcomingReviews || upcomingReviews.length === 0) {
            // No data case - draw empty chart with message
            if (upcomingChart) {
                upcomingChart.destroy();
            }
            
            ctx.font = '16px Arial';
            ctx.fillStyle = isDarkMode ? '#e0e0e0' : '#666';
            ctx.textAlign = 'center';
            ctx.fillText('No upcoming reviews for the next 7 days', 
                         ctx.canvas.width / 2, ctx.canvas.height / 2);
            return;
        }
        
        upcomingReviews.forEach(item => {
            try {
                // Parse the ISO date string
                const date = new Date(item.date);
                
                // Check if date is valid
                if (isNaN(date.getTime())) {
                    console.error("Invalid date:", item.date);
                    return;
                }
                
                // Format as "Mon DD"
                const formatted = date.toLocaleDateString('en-US', {
                    weekday: 'short',
                    day: 'numeric'
                });
                
                labels.push(formatted);
                data.push(item.count);
            } catch (e) {
                console.error("Error processing review date:", e);
            }
        });
        
        if (upcomingChart) {
            upcomingChart.destroy();
        }
        
        upcomingChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: '# of Cards Due',
                    data: data,
                    backgroundColor: isDarkMode ? 'rgba(13, 110, 253, 0.8)' : '#0d6efd',
                    borderColor: isDarkMode ? 'rgba(13, 110, 253, 1)' : '#0b5ed7',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            precision: 0,
                            color: textColor
                        },
                        grid: {
                            color: gridColor
                        }
                    },
                    x: {
                        ticks: {
                            color: textColor
                        },
                        grid: {
                            color: gridColor
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        bodyColor: textColor,
                        titleColor: textColor
                    },
                    legend: {
                        labels: {
                            color: textColor
                        }
                    }
                }
            }
        });

        // Handle empty data case
        if (!upcomingReviews || upcomingReviews.length === 0) {
            ctx.font = '16px Arial';
            ctx.fillStyle = isDarkMode ? '#e0e0e0' : '#666';
            ctx.textAlign = 'center';
            ctx.fillText('No upcoming reviews for the next 7 days', 
                        ctx.canvas.width / 2, ctx.canvas.height / 2);
        }
    }
    
    // Load stats on page load
    loadStats();
    
    // Refresh stats every 30 seconds
    setInterval(loadStats, 30000);

    // Listen for theme changes to update charts
    const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
            if (mutation.attributeName === 'data-bs-theme') {
                loadStats(); // Reload stats to redraw charts with appropriate colors
            }
        });
    });

    observer.observe(document.documentElement, {
        attributes: true,
        attributeFilter: ['data-bs-theme']
    });
});
</script>
{% endblock %}
