<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Memoria | {% block title %}{% endblock %}</title>
    
    <!-- Optimized theme detection - inline to prevent flash -->
    <script>
        (function() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.documentElement.setAttribute('data-bs-theme', 'dark');
            } else if (savedTheme === 'light') {
                document.documentElement.setAttribute('data-bs-theme', 'light');
            } else if (savedTheme === 'auto' || !savedTheme) {
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                document.documentElement.setAttribute('data-bs-theme', prefersDark ? 'dark' : 'light');
                if (!savedTheme) localStorage.setItem('theme', 'auto');
            }
        })();
    </script>
    
    <!-- Critical CSS loaded first -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/deck-search.css') }}">
    {% block styles %}{% endblock %}
    
    <!-- Defer jQuery loading -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" defer></script>
</head>
<body>
    {% include 'nav/desktop_top_nav.html' %}
    
    <!-- Mobile-only spacer -->
    <div class="d-block d-md-none" style="height: 20px;"></div>
    
    <!-- Mobile Navigation Components -->
    {% include 'nav/mobile_bottom_nav.html' %}
    {% include 'menus/mobile_theme_menu.html' %}
    {% include 'menus/mobile_add_actions_menu.html' %}
    {% include 'menus/mobile_study_stats_menu.html' %}
    {% include 'menus/theme_toggle_popup_menu.html' %}

    <!-- Common Modals - loaded only when needed -->
    {% include 'components/import_content_modal.html' %}
    {% include 'components/rename_deck_modal.html' %}
    {% include 'components/delete_deck_modal.html' %}
    {% include 'components/move_deck_modal.html' %}
    
    <!-- Deck-specific modals - conditional loading -->
    {% if request.path.startswith('/deck/') and request.path.split('/')[-1].isdigit() %}
        {% include 'components/create_sub_deck_modal.html' %}
        {% include 'components/generate_cards_modal_deck.html' %}
    {% endif %}
    
    <!-- Index-specific and Search-page modals - conditional loading -->
    {% if request.path == '/' or request.path == '/index' or request.path.startswith('/search') %}
        {% include 'components/create_empty_deck_modal.html' %}
        {% include 'components/generate_cards_modal_index.html' %}
        
        {% if all_decks is defined %}
            {% with decks=all_decks %}
                {% include 'components/select_deck_to_study_modal.html' %}
                {% include 'components/select_deck_for_stats_modal.html' %}
            {% endwith %}
        {% elif g.all_decks is defined %}
            {% with decks=g.all_decks %}
                {% include 'components/select_deck_to_study_modal.html' %}
                {% include 'components/select_deck_for_stats_modal.html' %}
            {% endwith %}
        {% endif %}
    {% endif %}

    <!-- Essential scripts with appropriate loading attributes -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" defer></script> 
    
    <!-- Optimized JavaScript module loading with defer -->
    <script type="module">
        import { initializeModals } from "{{ url_for('static', filename='modules/deck/modal-handlers.js') }}";
        import { initializeFormHandlers } from "{{ url_for('static', filename='modules/deck/form-handlers.js') }}";
        import { initializeDeckOperations } from "{{ url_for('static', filename='modules/deck/deck-operations.js') }}";
        
        // Single initialization point with deferred execution
        if (!window.memoria_initialized) {
            // Simple implementations first
            window.showImportModal = () => {
                const modal = document.getElementById('importContentModal');
                if (modal) new bootstrap.Modal(modal).show();
            };
            
            window.showGenerateModal = () => {
                const modal = document.getElementById('generateModal');
                if (modal) new bootstrap.Modal(modal).show();
            };
            
            // Use requestIdleCallback for non-critical initialization
            const initializeComponents = () => {
                console.log("Initializing Memoria components");
                const modals = initializeModals();
                initializeFormHandlers(modals);
                initializeDeckOperations();
                window.memoria_initialized = true;
            };
            
            // Initialize when DOM is loaded and idle
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', () => {
                    if (window.requestIdleCallback) {
                        requestIdleCallback(initializeComponents);
                    } else {
                        setTimeout(initializeComponents, 100);
                    }
                });
            } else {
                if (window.requestIdleCallback) {
                    requestIdleCallback(initializeComponents);
                } else {
                    setTimeout(initializeComponents, 100);
                }
            }
        }
    </script>
    
    <!-- Optimized theme management script -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Theme toggle functionality - combined and optimized
            const setupThemeToggle = () => {
                const themeToggle = document.getElementById('themeToggle');
                const themeMenu = document.getElementById('themeMenu');
                const themeBackdrop = document.getElementById('themeBackdrop');
                const themeMenuItems = document.querySelectorAll('.theme-menu-item');
                const htmlElement = document.documentElement;
                const prefersDarkScheme = window.matchMedia('(prefers-color-scheme: dark)');
                
                if (!themeToggle) return;
                
                // Mark active theme
                updateActiveThemeInMenu();
                
                // Event delegation for theme menu interactions
                document.addEventListener('click', (e) => {
                    // Toggle menu on button click
                    if (e.target.closest('#themeToggle')) {
                        themeMenu.classList.toggle('show');
                        themeBackdrop.classList.toggle('show');
                        return;
                    }
                    
                    // Hide menu when clicking outside
                    if (themeMenu && themeMenu.classList.contains('show') && 
                        !e.target.closest('#themeMenu')) {
                        themeMenu.classList.remove('show');
                        themeBackdrop.classList.remove('show');
                    }
                    
                    // Handle theme option click
                    const themeItem = e.target.closest('.theme-menu-item');
                    if (themeItem && themeMenu.classList.contains('show')) {
                        const theme = themeItem.getAttribute('data-theme');
                        
                        // Apply and save theme
                        applyTheme(theme);
                        localStorage.setItem('theme', theme);
                        updateActiveThemeInMenu();
                        
                        // Close menu
                        themeMenu.classList.remove('show');
                        themeBackdrop.classList.remove('show');
                    }
                });
                
                // Function to apply theme to document
                function applyTheme(theme) {
                    if (theme === 'dark') {
                        htmlElement.setAttribute('data-bs-theme', 'dark');
                    } else if (theme === 'light') {
                        htmlElement.setAttribute('data-bs-theme', 'light');
                    } else if (theme === 'auto') {
                        // For auto theme, follow system preference
                        htmlElement.setAttribute('data-bs-theme', 
                            prefersDarkScheme.matches ? 'dark' : 'light');
                    }
                }
                
                // Update active theme in menu
                function updateActiveThemeInMenu() {
                    const currentTheme = localStorage.getItem('theme') || 'auto';
                    
                    themeMenuItems.forEach(item => {
                        const itemTheme = item.getAttribute('data-theme');
                        item.classList.toggle('active', itemTheme === currentTheme);
                    });
                    
                    // Update toggle button icon
                    const currentAppliedTheme = htmlElement.getAttribute('data-bs-theme');
                    const iconElement = themeToggle.querySelector('i');
                    iconElement.className = currentAppliedTheme === 'dark' 
                        ? 'bi bi-moon-stars-fill'
                        : 'bi bi-sun-fill';
                }
                
                // Listen for system preference changes
                prefersDarkScheme.addEventListener('change', () => {
                    const currentTheme = localStorage.getItem('theme') || 'auto';
                    if (currentTheme === 'auto') {
                        applyTheme('auto');
                        updateActiveThemeInMenu();
                    }
                });
            };
            
            // Set up mobile menus with a more efficient approach
            const setupMobileMenus = () => {
                // Handle all similar menus with delegated events
                const menuButtons = {
                    'mobileAddButton': 'mobileAddMenu',
                    'mobileThemeToggle': 'mobileThemeMenu',
                    'mobileStudyStatsButton': 'mobileStudyStatsMenu'
                };
                
                // Use event delegation for better performance
                document.addEventListener('click', (e) => {
                    // Find if we clicked on a menu button
                    let menuToToggle = null;
                    for (const [btnId, menuId] of Object.entries(menuButtons)) {
                        if (e.target.closest(`#${btnId}`)) {
                            menuToToggle = document.getElementById(menuId);
                            break;
                        }
                    }
                    
                    if (menuToToggle) {
                        // Toggle the menu
                        menuToToggle.classList.toggle('active');
                        return;
                    }
                    
                    // Close button handlers
                    if (e.target.closest('[id$="MenuClose"]')) {
                        const menu = e.target.closest('.mobile-add-menu, .mobile-theme-menu, .mobile-study-stats-menu');
                        if (menu) menu.classList.remove('active');
                        return;
                    }
                    
                    // Backdrop handlers
                    if (e.target.closest('[id$="MenuBackdrop"]')) {
                        const menu = e.target.closest('.mobile-add-menu, .mobile-theme-menu, .mobile-study-stats-menu');
                        if (menu) menu.classList.remove('active');
                        return;
                    }
                    
                    // Close menu when an action is selected
                    if (e.target.closest('.mobile-add-menu .list-group-item, .mobile-theme-menu .mobile-theme-option, .mobile-study-stats-menu .list-group-item')) {
                        const menu = e.target.closest('.mobile-add-menu, .mobile-theme-menu, .mobile-study-stats-menu');
                        setTimeout(() => {
                            if (menu) menu.classList.remove('active');
                        }, 100);
                    }
                });
                
                // Mobile theme options handling
                document.addEventListener('click', (e) => {
                    const themeOption = e.target.closest('.mobile-theme-option');
                    if (themeOption) {
                        const theme = themeOption.getAttribute('data-theme');
                        const htmlElement = document.documentElement;
                        
                        // Apply and save the theme
                        localStorage.setItem('theme', theme);
                        
                        // Apply theme to document
                        if (theme === 'dark') {
                            htmlElement.setAttribute('data-bs-theme', 'dark');
                        } else if (theme === 'light') {
                            htmlElement.setAttribute('data-bs-theme', 'light');
                        } else if (theme === 'auto') {
                            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                            htmlElement.setAttribute('data-bs-theme', prefersDark ? 'dark' : 'light');
                        }
                        
                        // Update the theme toggle icon
                        updateMobileThemeIcon();
                        
                        // Show toast notification
                        showThemeChangeToast(theme);
                    }
                });
                
                // Highlight active navigation item
                const highlightActiveNavItem = () => {
                    const currentPath = window.location.pathname;
                    const navItems = document.querySelectorAll('.mobile-nav-item');
                    
                    if (!navItems.length) return;
                    
                    if (currentPath === '/' || currentPath === '/index') {
                        navItems[0].classList.add('active'); // Decks
                    } else if (currentPath.includes('/deck/') && !currentPath.includes('/study') && !currentPath.includes('/stats')) {
                        navItems[0].classList.add('active'); // Decks - still active when in deck view
                    } else if (currentPath.includes('/study')) {
                        navItems[1].classList.add('active'); // Study
                    } else if (currentPath.includes('/stats')) {
                        navItems[3].classList.add('active'); // Stats
                    }
                };
                
                highlightActiveNavItem();
            };
            
            // Clean implementation of mobile theme update functions
            const updateMobileThemeIcon = () => {
                const buttonElement = document.getElementById('mobileThemeToggle');
                if (!buttonElement) return;
                
                const currentTheme = localStorage.getItem('theme') || 'auto';
                const iconElement = buttonElement.querySelector('i');
                const textElement = buttonElement.querySelector('span');
                
                // Set icon and text based on theme
                iconElement.className = {
                    'dark': 'bi bi-moon-stars-fill',
                    'light': 'bi bi-sun-fill',
                    'auto': 'bi bi-circle-half'
                }[currentTheme] || 'bi bi-circle-half';
                
                textElement.textContent = {
                    'dark': 'Dark',
                    'light': 'Light',
                    'auto': 'Theme'
                }[currentTheme] || 'Theme';
            };
            
            function showThemeChangeToast(theme) {
                // Create toast element
                const toast = document.createElement('div');
                toast.className = 'theme-toast';
                
                const iconClass = {
                    'dark': 'bi-moon-stars-fill',
                    'light': 'bi-sun-fill',
                    'auto': 'bi-circle-half'
                }[theme] || 'bi-circle-half';
                
                const text = {
                    'dark': 'Dark Mode',
                    'light': 'Light Mode',
                    'auto': 'System Theme'
                }[theme] || 'System Theme';
                
                toast.innerHTML = `<i class="bi ${iconClass}"></i> ${text}`;
                document.body.appendChild(toast);
                
                // Animate in and out with efficient timing
                requestAnimationFrame(() => {
                    toast.classList.add('show');
                    setTimeout(() => {
                        toast.classList.remove('show');
                        setTimeout(() => toast.remove(), 300);
                    }, 2000);
                });
            }
            
            function updateActiveThemeOption() {
                const currentTheme = localStorage.getItem('theme') || 'auto';
                document.querySelectorAll('.mobile-theme-option').forEach(option => {
                    option.classList.toggle('active', option.getAttribute('data-theme') === currentTheme);
                });
            }
            
            // Batch setup functions for better performance
            if (window.requestIdleCallback) {
                requestIdleCallback(() => {
                    setupThemeToggle();
                    setupMobileMenus();
                    updateMobileThemeIcon();
                    updateActiveThemeOption();
                });
            } else {
                // Fallback for browsers without requestIdleCallback
                setTimeout(() => {
                    setupThemeToggle();
                    setupMobileMenus();
                    updateMobileThemeIcon();
                    updateActiveThemeOption();
                }, 50);
            }
        });
    </script>
    {% block scripts %}{% endblock %}
</body>
</html>