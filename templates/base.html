<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Memoria | {% block title %}{% endblock %}</title>
    
    <!-- Prevent theme flickering by setting theme before page renders -->
    <script>
        (function() {
            // Check for saved theme preference
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            
            // Apply theme immediately to prevent flash
            if (savedTheme === 'dark') {
                document.documentElement.setAttribute('data-bs-theme', 'dark');
            } else if (savedTheme === 'light') {
                document.documentElement.setAttribute('data-bs-theme', 'light');
            } else if (savedTheme === 'auto' || !savedTheme) {
                // For auto or no preference, follow system preference
                document.documentElement.setAttribute('data-bs-theme', prefersDark ? 'dark' : 'light');
                
                // If no preference is saved yet, default to auto
                if (!savedTheme) {
                    localStorage.setItem('theme', 'auto');
                }
            }
        })();
    </script>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') }}"></link>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    {% block styles %}{% endblock %}
</head>
<body>
    <!-- Add a spacer div at the bottom of the body for extra padding on mobile -->
    <div class="container py-4">
        {% block content %}{% endblock %}
    </div>
    
    <!-- Mobile-only spacer -->
    <div class="d-block d-md-none" style="height: 20px;"></div>
    
    <!-- Mobile Bottom Navigation -->
    <div class="mobile-bottom-nav">
        <a href="{{ url_for('main.index') }}" class="mobile-nav-item">
            <i class="bi bi-collection"></i>
            <span>Decks</span>
        </a>
        
        <!-- Study button - uses existing modal -->
        <button class="mobile-nav-item" data-bs-toggle="modal" data-bs-target="#selectDeckToStudyModal">
            <i class="bi bi-book"></i>
            <span>Study</span>
        </button>
        
        <!-- Add button - context-aware implementation -->
        <button class="mobile-nav-item" id="mobileAddButton">
            <i class="bi bi-plus-circle"></i>
            <span>Add</span>
        </button>
        
        <!-- Stats button - uses existing modal -->
        <button class="mobile-nav-item" data-bs-toggle="modal" data-bs-target="#selectDeckForStatsModal">
            <i class="bi bi-graph-up"></i>
            <span>Stats</span>
        </button>
        
        <!-- Theme toggle button for mobile -->
        <button class="mobile-nav-item" id="mobileThemeToggle">
            <i class="bi bi-circle-half"></i>
            <span>Theme</span>
        </button>
    </div>

    <!-- Mobile Theme Menu (hidden by default) -->
    <div class="mobile-theme-menu" id="mobileThemeMenu">
        <div class="mobile-theme-menu-backdrop" id="mobileThemeMenuBackdrop"></div>
        <div class="mobile-theme-menu-content">
            <div class="list-group">
                <button type="button" class="list-group-item list-group-item-action mobile-theme-option" data-theme="light">
                    <i class="bi bi-sun-fill me-2"></i> Light Mode
                    <i class="bi bi-check-lg check-icon"></i>
                </button>
                <button type="button" class="list-group-item list-group-item-action mobile-theme-option" data-theme="dark">
                    <i class="bi bi-moon-stars-fill me-2"></i> Dark Mode
                    <i class="bi bi-check-lg check-icon"></i>
                </button>
                <button type="button" class="list-group-item list-group-item-action mobile-theme-option" data-theme="auto">
                    <i class="bi bi-circle-half me-2"></i> System Preference
                    <i class="bi bi-check-lg check-icon"></i>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Mobile Add Actions Menu (hidden by default) -->
    <div class="mobile-add-menu" id="mobileAddMenu">
        <div class="mobile-add-menu-backdrop" id="mobileAddMenuBackdrop"></div>
        <div class="mobile-add-menu-content">
            <div class="list-group">
                <!-- Context-aware add cards option -->
                {% if request.path.startswith('/deck/') and request.path.split('/')[-1].isdigit() %}
                    <!-- In deck view - Add cards to this specific deck -->
                    <button type="button" class="list-group-item list-group-item-action" 
                            onclick="document.querySelector('.add-cards-btn')?.click(); return false;">
                        <i class="bi bi-card-text me-2"></i> Add Cards
                    </button>
                    
                    <!-- In deck view - Add sub-deck to this deck -->
                    <button type="button" class="list-group-item list-group-item-action" 
                            onclick="document.getElementById('createDeckBtn')?.click(); return false;">
                        <i class="bi bi-folder-symlink me-2"></i> New Sub-deck
                    </button>
                {% else %}
                    <!-- In home view - Generate cards (will prompt for deck) -->
                    <button type="button" class="list-group-item list-group-item-action" 
                            onclick="showGenerateModal(); return false;">
                        <i class="bi bi-card-text me-2"></i> Add Cards
                    </button>
                    
                    <!-- In home view - Create new empty deck -->
                    <button type="button" class="list-group-item list-group-item-action" 
                            onclick="document.getElementById('createEmptyDeckBtn')?.click(); return false;">
                        <i class="bi bi-folder me-2"></i> New Deck
                    </button>
                {% endif %}
                
                <!-- Import content - available in all contexts -->
                <button type="button" class="list-group-item list-group-item-action" 
                        onclick="showImportModal(); return false;">
                    <i class="bi bi-file-earmark-arrow-up me-2"></i> Import Content
                </button>
            </div>
            <button type="button" class="btn btn-outline-secondary w-100 mt-2" id="mobileAddMenuClose">
                Cancel
            </button>
        </div>
    </div>
    
    <!-- Theme Toggle with Popup Menu -->
    <div class="theme-backdrop" id="themeBackdrop"></div>
    <div class="theme-toggle-container">
        <div class="theme-menu" id="themeMenu">
            <button class="theme-menu-item" data-theme="light">
                <i class="bi bi-sun-fill theme-icon"></i>
                Light Mode
                <i class="bi bi-check-lg check-icon"></i>
            </button>
            <button class="theme-menu-item" data-theme="dark">
                <i class="bi bi-moon-stars-fill theme-icon"></i>
                Dark Mode
                <i class="bi bi-check-lg check-icon"></i>
            </button>
            <div class="theme-menu-divider"></div>
            <button class="theme-menu-item" data-theme="auto">
                <i class="bi bi-circle-half theme-icon"></i>
                System Preference
                <i class="bi bi-check-lg check-icon"></i>
            </button>
        </div>
        
        <button class="theme-toggle-btn" id="themeToggle" aria-label="Change theme">
            <i class="bi bi-palette"></i>
        </button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script> 
    <script>
        // Enhanced theme management with popup menu
        document.addEventListener('DOMContentLoaded', function() {
            const themeToggle = document.getElementById('themeToggle');
            const themeMenu = document.getElementById('themeMenu');
            const themeBackdrop = document.getElementById('themeBackdrop');
            const themeMenuItems = document.querySelectorAll('.theme-menu-item');
            const htmlElement = document.documentElement;
            
            // Media query for detecting system preference changes
            const prefersDarkScheme = window.matchMedia('(prefers-color-scheme: dark)');
            
            // Initialize: mark active theme
            updateActiveThemeInMenu();
            
            // Show/hide menu on button click
            themeToggle.addEventListener('click', () => {
                themeMenu.classList.toggle('show');
                themeBackdrop.classList.toggle('show');
            });
            
            // Hide menu when clicking outside
            themeBackdrop.addEventListener('click', () => {
                themeMenu.classList.remove('show');
                themeBackdrop.classList.remove('show');
            });
            
            // Theme menu item click handler
            themeMenuItems.forEach(item => {
                item.addEventListener('click', () => {
                    const theme = item.getAttribute('data-theme');
                    
                    // Apply theme
                    applyTheme(theme);
                    
                    // Save preference
                    localStorage.setItem('theme', theme);
                    
                    // Update UI
                    updateActiveThemeInMenu();
                    
                    // Close menu
                    themeMenu.classList.remove('show');
                    themeBackdrop.classList.remove('show');
                });
            });
            
            // Function to apply theme to document
            function applyTheme(theme) {
                if (theme === 'dark') {
                    htmlElement.setAttribute('data-bs-theme', 'dark');
                } else if (theme === 'light') {
                    htmlElement.setAttribute('data-bs-theme', 'light');
                } else if (theme === 'auto') {
                    // For auto theme, follow system preference
                    htmlElement.setAttribute('data-bs-theme', 
                        prefersDarkScheme.matches ? 'dark' : 'light');
                }
            }
            
            // Update active theme in menu
            function updateActiveThemeInMenu() {
                const currentTheme = localStorage.getItem('theme') || 'auto';
                
                themeMenuItems.forEach(item => {
                    const itemTheme = item.getAttribute('data-theme');
                    if (itemTheme === currentTheme) {
                        item.classList.add('active');
                    } else {
                        item.classList.remove('active');
                    }
                });
                
                // Update toggle button icon based on current applied theme
                updateToggleIcon();
            }
            
            // Update the toggle button icon based on current applied theme
            function updateToggleIcon() {
                const currentAppliedTheme = htmlElement.getAttribute('data-bs-theme');
                const iconElement = themeToggle.querySelector('i');
                
                // Remove all icon classes
                iconElement.className = '';
                
                // Add appropriate icon class based on current theme
                if (currentAppliedTheme === 'dark') {
                    iconElement.className = 'bi bi-moon-stars-fill';
                } else {
                    iconElement.className = 'bi bi-sun-fill';
                }
            }
            
            // Listen for system preference changes if using auto theme
            prefersDarkScheme.addEventListener('change', () => {
                const currentTheme = localStorage.getItem('theme') || 'auto';
                if (currentTheme === 'auto') {
                    applyTheme('auto');
                    updateToggleIcon();
                }
            });
        });
        
        // Mobile Add Menu functionality
        document.addEventListener('DOMContentLoaded', function() {
            const mobileAddButton = document.getElementById('mobileAddButton');
            const mobileAddMenu = document.getElementById('mobileAddMenu');
            const mobileAddMenuClose = document.getElementById('mobileAddMenuClose');
            const mobileAddMenuBackdrop = document.getElementById('mobileAddMenuBackdrop');
            
            if (mobileAddButton && mobileAddMenu) {
                // Toggle menu when add button is clicked
                mobileAddButton.addEventListener('click', function() {
                    mobileAddMenu.classList.toggle('active');
                });
                
                // Close menu when cancel button is clicked
                if (mobileAddMenuClose) {
                    mobileAddMenuClose.addEventListener('click', function() {
                        mobileAddMenu.classList.remove('active');
                    });
                }
                
                // Close menu when backdrop is clicked
                if (mobileAddMenuBackdrop) {
                    mobileAddMenuBackdrop.addEventListener('click', function() {
                        mobileAddMenu.classList.remove('active');
                    });
                }
                
                // Close menu when an action is selected
                mobileAddMenu.querySelectorAll('.list-group-item').forEach(item => {
                    item.addEventListener('click', function() {
                        setTimeout(() => {
                            mobileAddMenu.classList.remove('active');
                        }, 100);
                    });
                });
                
                // Highlight active section based on current URL
                const currentPath = window.location.pathname;
                const navItems = document.querySelectorAll('.mobile-nav-item');
                
                if (currentPath === '/' || currentPath === '/index') {
                    navItems[0].classList.add('active'); // Decks
                } else if (currentPath.includes('/deck/') && !currentPath.includes('/study') && !currentPath.includes('/stats')) {
                    navItems[0].classList.add('active'); // Decks - still active when in deck view
                } else if (currentPath.includes('/study')) {
                    navItems[1].classList.add('active'); // Study
                } else if (currentPath.includes('/stats')) {
                    navItems[3].classList.add('active'); // Stats
                }
            }
            
            // Mobile theme toggle functionality - UPDATED
            const mobileThemeToggle = document.getElementById('mobileThemeToggle');
            const mobileThemeMenu = document.getElementById('mobileThemeMenu');
            const mobileThemeMenuBackdrop = document.getElementById('mobileThemeMenuBackdrop');
            const mobileThemeOptions = document.querySelectorAll('.mobile-theme-option');
            
            // Set initial icon based on current theme
            if (mobileThemeToggle) {
                updateMobileThemeIcon(mobileThemeToggle);
                
                // Changed to toggle the theme menu instead of cycling through themes
                mobileThemeToggle.addEventListener('click', function() {
                    mobileThemeMenu.classList.toggle('active');
                    updateActiveThemeOption(); // Update checkmarks
                });
                
                // Close menu when backdrop is clicked
                if (mobileThemeMenuBackdrop) {
                    mobileThemeMenuBackdrop.addEventListener('click', function() {
                        mobileThemeMenu.classList.remove('active');
                    });
                }
                
                // Handle theme option selection
                mobileThemeOptions.forEach(option => {
                    option.addEventListener('click', function() {
                        const theme = this.getAttribute('data-theme');
                        const htmlElement = document.documentElement;
                        
                        // Apply and save the theme
                        localStorage.setItem('theme', theme);
                        
                        // Apply theme to document
                        if (theme === 'dark') {
                            htmlElement.setAttribute('data-bs-theme', 'dark');
                        } else if (theme === 'light') {
                            htmlElement.setAttribute('data-bs-theme', 'light');
                        } else if (theme === 'auto') {
                            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                            htmlElement.setAttribute('data-bs-theme', prefersDark ? 'dark' : 'light');
                        }
                        
                        // Update the theme toggle icon
                        updateMobileThemeIcon(mobileThemeToggle);
                        
                        // Show toast notification
                        showThemeChangeToast(theme);
                        
                        // Close the menu
                        mobileThemeMenu.classList.remove('active');
                    });
                });
            }
            
            function updateMobileThemeIcon(buttonElement) {
                const currentTheme = localStorage.getItem('theme') || 'auto';
                const iconElement = buttonElement.querySelector('i');
                const textElement = buttonElement.querySelector('span');
                
                // Remove all icon classes
                iconElement.className = '';
                
                // Add appropriate icon and text based on theme
                if (currentTheme === 'dark') {
                    iconElement.className = 'bi bi-moon-stars-fill';
                    textElement.textContent = 'Dark';
                } else if (currentTheme === 'light') {
                    iconElement.className = 'bi bi-sun-fill';
                    textElement.textContent = 'Light';
                } else { // auto
                    iconElement.className = 'bi bi-circle-half';
                    textElement.textContent = 'Theme';
                }
            }
            
            function showThemeChangeToast(theme) {
                // Create toast element
                const toast = document.createElement('div');
                toast.className = 'theme-toast';
                
                let icon, text;
                if (theme === 'dark') {
                    icon = 'bi-moon-stars-fill';
                    text = 'Dark Mode';
                } else if (theme === 'light') {
                    icon = 'bi-sun-fill';
                    text = 'Light Mode';
                } else { // auto
                    icon = 'bi-circle-half';
                    text = 'System Theme';
                }
                
                toast.innerHTML = `<i class="bi ${icon}"></i> ${text}`;
                document.body.appendChild(toast);
                
                // Animate in
                setTimeout(() => {
                    toast.classList.add('show');
                }, 10);
                
                // Animate out and remove
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => {
                        document.body.removeChild(toast);
                    }, 300);
                }, 2000);
            }
            
            function updateActiveThemeOption() {
                const currentTheme = localStorage.getItem('theme') || 'auto';
                mobileThemeOptions.forEach(option => {
                    const optionTheme = option.getAttribute('data-theme');
                    if (optionTheme === currentTheme) {
                        option.classList.add('active');
                    } else {
                        option.classList.remove('active');
                    }
                });
            }
        });
    </script>
    {% block scripts %}{% endblock %}
</body>
</html>
<!-- Hello there :DD -->