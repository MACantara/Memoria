<div class="modal fade" id="selectDeckToStudyModal" tabindex="-1" aria-labelledby="selectDeckToStudyModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="selectDeckToStudyModalLabel">Select Deck to Study</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="studyDeckSelect" class="form-label">Choose a deck to study:</label>
                    <select class="form-select" id="studyDeckSelect">
                        <option value="" disabled selected>Select a deck...</option>
                        
                        <!-- Root level decks -->
                        {% for deck in decks %}
                            {% if not deck.parent_deck_id %}
                                <option value="{{ deck.flashcard_deck_id }}" 
                                        data-card-count="{{ deck.count_all_flashcards() }}"
                                        data-has-cards="{{ 'true' if deck.count_all_flashcards() > 0 else 'false' }}">
                                    {{ deck.name }} ({{ deck.count_all_flashcards() }} cards)
                                </option>
                                
                                <!-- First level sub-decks -->
                                {% for subdeck in deck.child_decks %}
                                    <option value="{{ subdeck.flashcard_deck_id }}" 
                                            data-card-count="{{ subdeck.count_all_flashcards() }}"
                                            data-has-cards="{{ 'true' if subdeck.count_all_flashcards() > 0 else 'false' }}">
                                        &nbsp;&nbsp;└─ {{ subdeck.name }} ({{ subdeck.count_all_flashcards() }} cards)
                                    </option>
                                    
                                    <!-- Second level sub-decks -->
                                    {% for subsubdeck in subdeck.child_decks %}
                                        <option value="{{ subsubdeck.flashcard_deck_id }}" 
                                                data-card-count="{{ subsubdeck.count_all_flashcards() }}"
                                                data-has-cards="{{ 'true' if subsubdeck.count_all_flashcards() > 0 else 'false' }}">
                                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;└─ {{ subsubdeck.name }} ({{ subsubdeck.count_all_flashcards() }} cards)
                                        </option>
                                    {% endfor %}
                                {% endfor %}
                            {% endif %}
                        {% endfor %}
                    </select>
                </div>
                
                <div class="d-flex justify-content-between mt-4">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="studyDueOnly">
                        <label class="form-check-label" for="studyDueOnly">
                            Only show cards due today
                        </label>
                    </div>
                    <span id="selectedDeckCardCount" class="text-muted">
                        <!-- Card count will appear here -->
                    </span>
                </div>
                
                <div class="alert alert-warning d-none" id="noDeckSelectedWarning">
                    <i class="bi bi-exclamation-triangle me-2"></i> Please select a deck first.
                </div>
                
                <div class="alert alert-info d-none" id="noCardsWarning">
                    <i class="bi bi-info-circle me-2"></i> This deck has no cards. Please add cards first.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="startStudyingBtn">
                    <i class="bi bi-book"></i> Start Studying
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const selectDeckModal = document.getElementById('selectDeckToStudyModal');
        if (!selectDeckModal) return;
        
        const deckSelect = document.getElementById('studyDeckSelect');
        const dueOnlyCheckbox = document.getElementById('studyDueOnly');
        const startStudyingBtn = document.getElementById('startStudyingBtn');
        const noDeckSelectedWarning = document.getElementById('noDeckSelectedWarning');
        const noCardsWarning = document.getElementById('noCardsWarning');
        const selectedDeckCardCount = document.getElementById('selectedDeckCardCount');
        
        // Update UI when a deck is selected
        deckSelect.addEventListener('change', function() {
            const selectedOption = deckSelect.options[deckSelect.selectedIndex];
            const hasCards = selectedOption.dataset.hasCards === 'true';
            const cardCount = selectedOption.dataset.cardCount || 0;
            
            // Reset warning states
            noDeckSelectedWarning.classList.add('d-none');
            noCardsWarning.classList.add('d-none');
            
            // Show card count for the selected deck
            selectedDeckCardCount.textContent = `${cardCount} cards`;
            
            // Show warning if the deck has no cards
            if (!hasCards) {
                noCardsWarning.classList.remove('d-none');
            }
        });
        
        // Handle the study button click
        startStudyingBtn.addEventListener('click', function() {
            const deckId = deckSelect.value;
            const dueOnly = dueOnlyCheckbox.checked;
            
            // Validate selection
            if (!deckId) {
                noDeckSelectedWarning.classList.remove('d-none');
                return;
            }
            
            const selectedOption = deckSelect.options[deckSelect.selectedIndex];
            const hasCards = selectedOption.dataset.hasCards === 'true';
            
            if (!hasCards) {
                noCardsWarning.classList.remove('d-none');
                return;
            }
            
            // Navigate to the study page
            window.location.href = `/deck/${deckId}/study${dueOnly ? '?due_only=true' : ''}`;
        });
    });
</script>
