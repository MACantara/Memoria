<div class="modal fade" id="importContentModal" tabindex="-1" aria-labelledby="importContentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="importContentModalLabel">Import Content</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Add a workflow explanation at the top -->
                <div class="alert alert-info workflow-guide">
                    <i class="bi bi-info-circle me-2"></i>
                    <strong>How this works:</strong>
                    <ol class="mb-0">
                        <li>Upload a file and select a deck</li>
                        <li>Generate flashcards from the content</li>
                        <li>Review the flashcards</li>
                        <li>Click "Save Flashcards" when you're satisfied</li>
                    </ol>
                </div>

                <ul class="nav nav-tabs mb-3" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" id="upload-tab" data-bs-toggle="tab" href="#uploadContent" role="tab">
                            <i class="bi bi-cloud-upload me-1"></i> 1. Upload File
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="results-tab" data-bs-toggle="tab" href="#resultsContent" role="tab">
                            <i class="bi bi-card-list me-1"></i> 2. Review Results
                        </a>
                    </li>
                </ul>
                
                <div class="tab-content">
                    <!-- Upload Tab -->
                    <div class="tab-pane fade show active" id="uploadContent" role="tabpanel">
                        <form id="importFileForm">
                            <div class="mb-3">
                                <label for="importDeckSelect" class="form-label">Choose a deck:</label>
                                                               
                                <div class="select-container">
                                    <select class="form-select deck-search-select" id="importDeckSelect" name="deck_id" required 
                                            size="8" style="height: auto;">
                                        <option value="" disabled selected>Choose a deck...</option>
                                        
                                        {% macro render_deck_option(deck, depth=0) %}
                                            {% set indent = "&nbsp;&nbsp;" * depth %}
                                            {% set prefix = "â”” " if depth > 0 else "" %}
                                            <option value="{{ deck.flashcard_deck_id }}" data-deck-name="{{ deck.name | lower }}">{{ indent | safe }}{{ prefix }}{{ deck.name }}</option>
                                            
                                            {% for child_deck in deck.child_decks %}
                                                {{ render_deck_option(child_deck, depth+1) }}
                                            {% endfor %}
                                        {% endmacro %}
                                        
                                        {% for deck in g.all_decks if not deck.parent_deck_id %}
                                            {{ render_deck_option(deck) }}
                                        {% endfor %}
                                    </select>
                                </div>
                                <small class="text-muted mt-1">Select a deck where you want to import the flashcards</small>
                            </div>
                            
                            <div class="mb-3">
                                <div class="drag-area" id="dragArea">
                                    <div class="drag-area-inner">
                                        <i class="bi bi-cloud-arrow-up fs-3 mb-2"></i>
                                        <h5>Drag & Drop Files Here</h5>
                                        <p class="text-muted">or</p>
                                        <button type="button" class="btn btn-primary" id="browseBtn">Browse Files</button>
                                        <input type="file" hidden id="fileInput" name="file" accept=".txt,.pdf" />
                                        <p class="mt-2 text-muted small">Supported formats: PDF, TXT</p>
                                    </div>
                                </div>
                                <div id="fileInfo" class="mt-2 d-none">
                                    <div class="alert alert-info">
                                        <i class="bi bi-file-earmark-text me-2"></i>
                                        <span id="fileName"></span>
                                        <button type="button" class="btn-close float-end" id="removeFile"></button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary" id="importBtn" disabled>
                                    <i class="bi bi-magic"></i> Generate Flashcards
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Results Tab -->
                    <div class="tab-pane fade" id="resultsContent" role="tabpanel">
                        <div id="processingInfo" class="d-none">
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i>
                                <span id="processingStatus">Processing file...</span>
                                <div class="progress mt-2">
                                    <div class="progress-bar" role="progressbar" style="width: 0%;" 
                                         id="processingProgress" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="importResults" class="mt-3">
                            <!-- Generated flashcards will appear here -->
                        </div>

                        <!-- Add clear instructions for the next step -->
                        <div id="nextStepInstructions" class="alert alert-success d-none mt-3">
                            <i class="bi bi-arrow-down-circle-fill me-2"></i>
                            <strong>Next Step:</strong> Review the flashcards above. If you're satisfied, click the "Save Flashcards" button below to add them to your selected deck.
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success d-none" id="saveFlashcardsBtn">
                    <i class="bi bi-save me-1"></i> Save Flashcards to Deck
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    /* Enhanced drag and drop styling */
    .drag-area {
        border: 2px dashed #6c757d;
        border-radius: 8px;
        background-color: rgba(0,0,0,0.02);
        text-align: center;
        min-height: 180px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .drag-area-inner {
        padding: 30px;
        width: 100%;
    }
    
    .drag-area.active {
        border-color: #0d6efd;
        background-color: rgba(13, 110, 253, 0.05);
        animation: pulse 1.5s infinite;
    }
    
    .drag-area:hover {
        border-color: #0d6efd;
        background-color: rgba(13, 110, 253, 0.03);
    }
    
    @keyframes pulse {
        0% {
            box-shadow: 0 0 0 0 rgba(13, 110, 253, 0.3);
        }
        70% {
            box-shadow: 0 0 0 10px rgba(13, 110, 253, 0);
        }
        100% {
            box-shadow: 0 0 0 0 rgba(13, 110, 253, 0);
        }
    }
    
    /* Make the loading spinner hidden by default */
    .select-container {
        position: relative;
    }
    
    .select-container .loading-spinner {
        position: absolute;
        right: 30px;
        top: 50%;
        transform: translateY(-50%);
        z-index: 10;
        /* Ensure spinner rotates correctly */
        animation: spinner-border-dropdown 0.75s linear infinite;
        border-radius: 50%;
    }
    
    /* Ensure proper spinner animation for dropdown spinners */
    @keyframes spinner-border-dropdown {
        to { transform: rotate(360deg); }
    }
    
    /* Add a separate animation for button spinners without translateY */
    .btn .spinner-border {
        animation: spinner-border-button 0.75s linear infinite;
    }
    
    /* Button spinner animation - rotation only, no vertical translation */
    @keyframes spinner-border-button {
        to { transform: rotate(360deg); }
    }
    
    .select-container.select-loading .loading-spinner {
        display: block !important;
    }
    
    /* File info styling */
    #fileInfo .alert {
        display: flex;
        align-items: center;
        padding: 10px 15px;
    }
    
    #fileInfo .alert i {
        font-size: 1.2em;
        margin-right: 8px;
    }
    
    /* Search styling */
    .deck-search-input {
        padding-left: 0;
    }
    
    .deck-search-input:focus {
        box-shadow: none;
    }
    
    .deck-search-select {
        margin-top: 0;
    }
    
    .select-container {
        position: relative;
    }
    
    /* Search feedback message */
    .search-feedback {
        display: none;
        font-size: 0.875rem;
        padding: 0.5rem;
        color: var(--bs-secondary);
        text-align: center;
    }
    
    .no-results .search-feedback {
        display: block;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // DOM elements
        const dragArea = document.getElementById('dragArea');
        const browseBtn = document.getElementById('browseBtn');
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const removeFile = document.getElementById('removeFile');
        const importBtn = document.getElementById('importBtn');
        const importDeckSelect = document.getElementById('importDeckSelect');
        const importFileForm = document.getElementById('importFileForm');
        const processingInfo = document.getElementById('processingInfo');
        const processingStatus = document.getElementById('processingStatus');
        const processingProgress = document.getElementById('processingProgress');
        const importResults = document.getElementById('importResults');
        const saveFlashcardsBtn = document.getElementById('saveFlashcardsBtn');
        const resultsTab = document.getElementById('results-tab');
        const deckSearchInput = document.getElementById('deckSearchInput');
        
        // Global variables
        let fileKey = null;
        let generatedFlashcards = [];
        
        // Initialize when modal is shown
        $('#importContentModal').on('shown.bs.modal', function () {
            // Reset drag area and file input
            resetFileInput();
            
            // Clear search input
            if (deckSearchInput) {
                deckSearchInput.value = '';
                filterDeckOptions('');
            }
            
            // Call attention to drag area with subtle pulse
            dragArea.classList.add('pulse-once');
            setTimeout(() => dragArea.classList.remove('pulse-once'), 1500);
        });
        
        // Add search functionality
        if (deckSearchInput) {
            // Add no results feedback if not already present
            if (!importDeckSelect.nextElementSibling || !importDeckSelect.nextElementSibling.classList.contains('search-feedback')) {
                const feedbackElement = document.createElement('div');
                feedbackElement.className = 'search-feedback';
                feedbackElement.textContent = 'No matching decks found';
                importDeckSelect.parentNode.insertBefore(feedbackElement, importDeckSelect.nextSibling);
            }
            
            deckSearchInput.addEventListener('input', function() {
                const searchTerm = this.value.trim().toLowerCase();
                filterDeckOptions(searchTerm);
            });
            
            // Clear button to reset search
            deckSearchInput.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    this.value = '';
                    filterDeckOptions('');
                }
            });
        }
        
        // Filter deck options based on search term
        function filterDeckOptions(searchTerm) {
            const options = importDeckSelect.querySelectorAll('option:not([disabled])');
            let visibleCount = 0;
            
            options.forEach(option => {
                const deckName = option.dataset.deckName || option.textContent.toLowerCase();
                const isMatch = searchTerm === '' || deckName.includes(searchTerm);
                
                option.style.display = isMatch ? '' : 'none';
                if (isMatch) visibleCount++;
            });
            
            // Add or remove no-results class
            if (visibleCount === 0 && searchTerm !== '') {
                importDeckSelect.parentNode.classList.add('no-results');
            } else {
                importDeckSelect.parentNode.classList.remove('no-results');
            }
            
            // Ensure first visible option is pre-selected if there is no current selection
            if (!importDeckSelect.value || importDeckSelect.selectedOptions[0].style.display === 'none') {
                const firstVisibleOption = Array.from(options).find(opt => opt.style.display !== 'none');
                if (firstVisibleOption) {
                    firstVisibleOption.selected = true;
                    // Update import button state if needed
                    importBtn.disabled = !importDeckSelect.value || !fileInput.files.length;
                }
            }
        }
        
        // Drag and Drop events
        dragArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            this.classList.add('active');
        });
        
        dragArea.addEventListener('dragleave', function() {
            this.classList.remove('active');
        });
        
        dragArea.addEventListener('drop', function(e) {
            e.preventDefault();
            this.classList.remove('active');
            
            const file = e.dataTransfer.files[0];
            handleFile(file);
        });
        
        // Make dragArea also clickable to open file dialog
        dragArea.addEventListener('click', function(e) {
            if (e.target !== browseBtn) {
                fileInput.click();
            }
        });
        
        // Browse button
        browseBtn.addEventListener('click', function() {
            fileInput.click();
        });
        
        // File input change
        fileInput.addEventListener('change', function() {
            if (this.files.length > 0) {
                handleFile(this.files[0]);
            }
        });
        
        // Remove file
        removeFile.addEventListener('click', function() {
            resetFileInput();
        });
        
        // Handle selected file with improved UI feedback
        function handleFile(file) {
            const validTypes = ['.txt', '.pdf'];
            const extension = '.' + file.name.split('.').pop().toLowerCase();
            
            if (!validTypes.includes(extension)) {
                // Show invalid file type error
                fileInfo.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        Invalid file type. Please upload a TXT or PDF file.
                    </div>
                `;
                fileInfo.classList.remove('d-none');
                importBtn.disabled = true;
                return;
            }
            
            // Show file info with enhanced styling
            fileName.textContent = file.name;
            const fileSize = (file.size / 1024).toFixed(2);
            const fileIcon = file.name.toLowerCase().endsWith('.pdf') ? 'bi-file-earmark-pdf' : 'bi-file-earmark-text';
            
            fileInfo.innerHTML = `
                <div class="alert alert-info">
                    <i class="${fileIcon} me-2"></i>
                    <div class="d-flex justify-content-between align-items-center w-100">
                        <div>
                            <strong>${file.name}</strong>
                            <div class="small text-muted">${fileSize} KB</div>
                        </div>
                        <button type="button" class="btn-close" id="removeFile"></button>
                    </div>
                </div>
            `;
            
            fileInfo.classList.remove('d-none');
            dragArea.classList.add('d-none');
            
            // Attach remove button listener again since we recreated the button
            document.getElementById('removeFile').addEventListener('click', resetFileInput);
            
            // Enable import button if deck is selected
            importBtn.disabled = !importDeckSelect.value;
            
            // Store file in input for form submission
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(file);
            fileInput.files = dataTransfer.files;
        }
        
        // Reset file input
        function resetFileInput() {
            fileInput.value = '';
            fileInfo.classList.add('d-none');
            dragArea.classList.remove('d-none');
            importBtn.disabled = true;
        }
        
        // Enable import button only when both file and deck are selected
        importDeckSelect.addEventListener('change', function() {
            importBtn.disabled = !this.value || !fileInput.files.length;
        });
        
        // Import form submission
        importFileForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (!fileInput.files.length || !importDeckSelect.value) {
                return;
            }
            
            // Show results tab
            const resultsTabInstance = new bootstrap.Tab(resultsTab);
            resultsTabInstance.show();
            
            // Show processing info
            processingInfo.classList.remove('d-none');
            processingProgress.style.width = '0%';
            processingProgress.textContent = '0%';
            processingStatus.textContent = 'Uploading file...';
            importResults.innerHTML = '';
            
            // Upload file
            const formData = new FormData(this);
            
            fetch('/import/upload-file', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) throw new Error('Upload failed');
                return response.json();
            })
            .then(data => {
                if (data.error) throw new Error(data.error);
                
                fileKey = data.file_key;
                processingStatus.textContent = `Processing file ${data.filename}... 0/${data.total_chunks} chunks`;
                
                // Start processing chunks
                return processNextChunk(fileKey);
            })
            .catch(error => {
                processingInfo.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        Error: ${error.message}
                    </div>
                `;
            });
        });
        
        // Process file chunks
        function processNextChunk(fileKey) {
            return fetch('/import/generate-chunk', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ file_key: fileKey })
            })
            .then(response => {
                if (!response.ok) throw new Error('Processing failed');
                return response.json();
            })
            .then(data => {
                if (data.error) throw new Error(data.error);
                
                // Update progress
                const progress = Math.round((data.chunk_index + 1) / data.total_chunks * 100);
                processingProgress.style.width = `${progress}%`;
                processingProgress.textContent = `${progress}%`;
                processingStatus.textContent = `Processing file... (${data.chunk_index + 1}/${data.total_chunks} chunks)`;
                
                // Update results
                return updateResults(fileKey)
                    .then(() => {
                        // Continue processing or complete
                        if (!data.is_complete) {
                            return processNextChunk(fileKey);
                        } else {
                            processingStatus.textContent = 'Processing complete!';
                            processingInfo.innerHTML = `
                                <div class="alert alert-success">
                                    <i class="bi bi-check-circle me-2"></i>
                                    <strong>Generation Complete!</strong> Generated ${generatedFlashcards.length} flashcards successfully!
                                </div>
                            `;
                            saveFlashcardsBtn.classList.remove('d-none');
                            
                            // Show the next step instructions
                            document.getElementById('nextStepInstructions').classList.remove('d-none');
                            
                            return Promise.resolve();
                        }
                    });
            });
        }
        
        // Update flashcard results
        function updateResults(fileKey) {
            return fetch(`/import/all-file-flashcards?file_key=${fileKey}&format=mc`)
                .then(response => {
                    if (!response.ok) throw new Error('Failed to fetch flashcards');
                    return response.json();
                })
                .then(data => {
                    generatedFlashcards = data.mc_flashcards || [];
                    importResults.innerHTML = '';
                    
                    // Show all flashcards instead of limiting to 10
                    if (generatedFlashcards.length === 0) {
                        importResults.innerHTML = '<p class="text-muted">No flashcards generated yet...</p>';
                        return;
                    }
                    
                    const cardRows = [];
                    for (let i = 0; i < generatedFlashcards.length; i += 2) {
                        const row = document.createElement('div');
                        row.className = 'row g-3 mb-3';
                        
                        // First card in row
                        const card1 = previewCardHTML(generatedFlashcards[i], i);
                        row.innerHTML += card1;
                        
                        // Second card in row (if exists)
                        if (i + 1 < generatedFlashcards.length) {
                            const card2 = previewCardHTML(generatedFlashcards[i + 1], i + 1);
                            row.innerHTML += card2;
                        }
                        
                        cardRows.push(row);
                    }
                    
                    // Show message with total count
                    const totalMessage = document.createElement('p');
                    totalMessage.className = 'alert alert-info';
                    totalMessage.innerHTML = `<i class="bi bi-info-circle me-2"></i> Showing all ${generatedFlashcards.length} generated flashcards`;
                    
                    importResults.appendChild(totalMessage);
                    cardRows.forEach(row => importResults.appendChild(row));
                    
                    // Add event listeners for delete buttons
                    setupDeleteCardButtons();
                });
        }

        // Generate HTML for preview card
        function previewCardHTML(card, index) {
            return `
                <div class="col-md-6">
                    <div class="card h-100" data-card-index="${index}">
                        <div class="card-header bg-transparent d-flex justify-content-between align-items-center py-2">
                            <div class="small text-muted">Card #${index + 1}</div>
                            <button type="button" class="btn btn-sm btn-outline-danger delete-card-btn" 
                                    data-index="${index}" aria-label="Delete card">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                        <div class="card-body">
                            <h5 class="card-title text-primary">
                                <i class="bi bi-question-circle"></i> ${card.q}
                            </h5>
                            <hr>
                            <p class="card-text">
                                <i class="bi bi-check-circle-fill text-success"></i> <strong>${card.ca}</strong>
                            </p>
                            <p class="card-text small text-muted">
                                <i class="bi bi-x-circle"></i> ${card.ia.join(', ')}
                            </p>
                        </div>
                    </div>
                </div>
            `;
        }

        // Add function to setup delete card buttons
        function setupDeleteCardButtons() {
            const deleteButtons = document.querySelectorAll('.delete-card-btn');
            deleteButtons.forEach(button => {
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const index = parseInt(this.dataset.index);
                    const cardElement = this.closest('.card');
                    const colElement = cardElement.closest('.col-md-6');
                    
                    // Show confirmation dialog
                    if (confirm('Are you sure you want to delete this flashcard?')) {
                        // Remove the card from the generated flashcards array
                        generatedFlashcards.splice(index, 1);
                        
                        // Remove the card from the UI with animation
                        cardElement.style.transition = 'all 0.3s ease';
                        cardElement.style.opacity = '0';
                        cardElement.style.transform = 'translateY(-10px)';
                        
                        setTimeout(() => {
                            // Use fade out animation before removing
                            colElement.remove();
                            
                            // If the row is now empty (no siblings), remove the row
                            const row = colElement.parentElement;
                            if (row && row.children.length === 0) {
                                row.remove();
                            }
                            
                            // Update count message
                            const totalMessage = importResults.querySelector('.alert-info');
                            if (totalMessage) {
                                const visibleCardsCount = document.querySelectorAll('.delete-card-btn').length;
                                totalMessage.innerHTML = `
                                    <i class="bi bi-info-circle me-2"></i> 
                                    Showing all ${generatedFlashcards.length} generated flashcards
                                `;
                            }
                            
                            // Re-index the remaining visible cards
                            document.querySelectorAll('.delete-card-btn').forEach((btn, newIndex) => {
                                btn.dataset.index = newIndex;
                                const card = btn.closest('.card');
                                card.dataset.cardIndex = newIndex;
                                const cardNumber = card.querySelector('.card-header .small');
                                if (cardNumber) {
                                    cardNumber.textContent = `Card #${newIndex + 1}`;
                                }
                            });
                            
                            // If all cards are deleted, show empty state
                            if (generatedFlashcards.length === 0) {
                                importResults.innerHTML = '<div class="alert alert-warning"><i class="bi bi-exclamation-triangle me-2"></i>All flashcards have been deleted.</div>';
                                saveFlashcardsBtn.classList.add('d-none');
                            }
                        }, 300);
                    }
                });
            });
        }
        
        // Save flashcards to deck - update to handle deleted cards
        saveFlashcardsBtn.addEventListener('click', function() {
            if (!fileKey || !importDeckSelect.value || generatedFlashcards.length === 0) {
                return;
            }
            
            this.disabled = true;
            this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...';
            
            fetch('/import/save-to-deck', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    file_key: fileKey,
                    deck_id: importDeckSelect.value,
                    flashcards: generatedFlashcards // Send only the remaining flashcards
                })
            })
            .then(response => {
                if (!response.ok) throw new Error('Save failed');
                return response.json();
            })
            .then(data => {
                if (data.error) throw new Error(data.error);
                
                // Show success message
                processingInfo.innerHTML = `
                    <div class="alert alert-success">
                        <i class="bi bi-check-circle me-2"></i>
                        <strong>Success!</strong> ${data.message || 'Flashcards saved successfully!'}
                    </div>
                `;
                
                // Hide the next step instructions after saving
                document.getElementById('nextStepInstructions').classList.add('d-none');
                
                // Close modal after delay
                setTimeout(() => {
                    const modalInstance = bootstrap.Modal.getInstance(document.getElementById('importContentModal'));
                    modalInstance.hide();
                    
                    // Refresh page or update deck list if needed
                    if (window.location.href.includes('/deck/')) {
                        window.location.reload();
                    }
                }, 2000);
            })
            .catch(error => {
                this.disabled = false;
                this.innerHTML = '<i class="bi bi-save"></i> Save Flashcards';
                
                processingInfo.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        Error: ${error.message}
                    </div>
                `;
            });
        });
    });
</script>
