<div class="modal fade" id="importContentModal" tabindex="-1" aria-labelledby="importContentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="importContentModalLabel">Import Content</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <ul class="nav nav-tabs mb-3" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" id="upload-tab" data-bs-toggle="tab" href="#uploadContent" role="tab">Upload File</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="results-tab" data-bs-toggle="tab" href="#resultsContent" role="tab">Results</a>
                    </li>
                </ul>
                
                <div class="tab-content">
                    <!-- Upload Tab -->
                    <div class="tab-pane fade show active" id="uploadContent" role="tabpanel">
                        <form id="importFileForm">
                            <div class="mb-3">
                                <label for="deckSelector" class="form-label">Select Deck:</label>
                                <div class="select-container">
                                    <select class="form-select" id="deckSelector" name="deck_id" required>
                                        <option value="" selected disabled>Choose a deck...</option>
                                        <!-- Deck options will be populated dynamically -->
                                    </select>
                                    <div class="loading-spinner spinner-border spinner-border-sm text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <div class="drag-area" id="dragArea">
                                    <i class="bi bi-cloud-arrow-up"></i>
                                    <h5>Drag & Drop your file here</h5>
                                    <p>or</p>
                                    <button type="button" class="btn btn-primary" id="browseBtn">Browse Files</button>
                                    <input type="file" hidden id="fileInput" name="file" accept=".txt,.pdf" />
                                    <p class="mt-2 text-muted">Supported formats: PDF, TXT</p>
                                </div>
                                <div id="fileInfo" class="mt-2 d-none">
                                    <div class="alert alert-info">
                                        <i class="bi bi-file-earmark-text me-2"></i>
                                        <span id="fileName"></span>
                                        <button type="button" class="btn-close float-end" id="removeFile"></button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary" id="importBtn" disabled>
                                    <i class="bi bi-magic"></i> Generate Flashcards
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Results Tab -->
                    <div class="tab-pane fade" id="resultsContent" role="tabpanel">
                        <div id="processingInfo" class="d-none">
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i>
                                <span id="processingStatus">Processing file...</span>
                                <div class="progress mt-2">
                                    <div class="progress-bar" role="progressbar" style="width: 0%;" 
                                         id="processingProgress" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="importResults" class="mt-3">
                            <!-- Generated flashcards will appear here -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-success d-none" id="saveFlashcardsBtn">Save Flashcards</button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // DOM elements
        const dragArea = document.getElementById('dragArea');
        const browseBtn = document.getElementById('browseBtn');
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const removeFile = document.getElementById('removeFile');
        const importBtn = document.getElementById('importBtn');
        const deckSelector = document.getElementById('deckSelector');
        const importFileForm = document.getElementById('importFileForm');
        const processingInfo = document.getElementById('processingInfo');
        const processingStatus = document.getElementById('processingStatus');
        const processingProgress = document.getElementById('processingProgress');
        const importResults = document.getElementById('importResults');
        const saveFlashcardsBtn = document.getElementById('saveFlashcardsBtn');
        const resultsTab = document.getElementById('results-tab');
        
        // Global variables
        let fileKey = null;
        let generatedFlashcards = [];
        
        // Initialize deck selector
        function loadDecks() {
            deckSelector.closest('.select-container').classList.add('select-loading');
            
            fetch('/decks/list')
                .then(response => response.json())
                .then(data => {
                    deckSelector.innerHTML = '<option value="" selected disabled>Choose a deck...</option>';
                    data.decks.forEach(deck => {
                        const option = document.createElement('option');
                        option.value = deck.id;
                        option.textContent = deck.name;
                        deckSelector.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Error loading decks:', error);
                    deckSelector.innerHTML = '<option value="" selected disabled>Error loading decks</option>';
                })
                .finally(() => {
                    deckSelector.closest('.select-container').classList.remove('select-loading');
                });
        }
        
        // Initialize when modal is shown
        $('#importContentModal').on('shown.bs.modal', function () {
            loadDecks();
        });
        
        // Drag and Drop events
        dragArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            this.classList.add('active');
        });
        
        dragArea.addEventListener('dragleave', function() {
            this.classList.remove('active');
        });
        
        dragArea.addEventListener('drop', function(e) {
            e.preventDefault();
            this.classList.remove('active');
            
            const file = e.dataTransfer.files[0];
            handleFile(file);
        });
        
        // Browse button
        browseBtn.addEventListener('click', function() {
            fileInput.click();
        });
        
        // File input change
        fileInput.addEventListener('change', function() {
            if (this.files.length > 0) {
                handleFile(this.files[0]);
            }
        });
        
        // Remove file
        removeFile.addEventListener('click', function() {
            resetFileInput();
        });
        
        // Handle selected file
        function handleFile(file) {
            const validTypes = ['.txt', '.pdf'];
            const extension = '.' + file.name.split('.').pop().toLowerCase();
            
            if (!validTypes.includes(extension)) {
                // Show invalid file type error
                fileInfo.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        Invalid file type. Please upload a TXT or PDF file.
                    </div>
                `;
                fileInfo.classList.remove('d-none');
                importBtn.disabled = true;
                return;
            }
            
            // Show file info
            fileName.textContent = file.name;
            fileInfo.classList.remove('d-none');
            dragArea.classList.add('d-none');
            
            // Enable import button if deck is selected
            importBtn.disabled = !deckSelector.value;
            
            // Store file in input for form submission
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(file);
            fileInput.files = dataTransfer.files;
        }
        
        // Reset file input
        function resetFileInput() {
            fileInput.value = '';
            fileInfo.classList.add('d-none');
            dragArea.classList.remove('d-none');
            importBtn.disabled = true;
        }
        
        // Enable import button only when both file and deck are selected
        deckSelector.addEventListener('change', function() {
            importBtn.disabled = !this.value || !fileInput.files.length;
        });
        
        // Import form submission
        importFileForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (!fileInput.files.length || !deckSelector.value) {
                return;
            }
            
            // Show results tab
            const resultsTabInstance = new bootstrap.Tab(resultsTab);
            resultsTabInstance.show();
            
            // Show processing info
            processingInfo.classList.remove('d-none');
            processingProgress.style.width = '0%';
            processingProgress.textContent = '0%';
            processingStatus.textContent = 'Uploading file...';
            importResults.innerHTML = '';
            
            // Upload file
            const formData = new FormData(this);
            
            fetch('/import/upload-file', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) throw new Error('Upload failed');
                return response.json();
            })
            .then(data => {
                if (data.error) throw new Error(data.error);
                
                fileKey = data.file_key;
                processingStatus.textContent = `Processing file ${data.filename}... 0/${data.total_chunks} chunks`;
                
                // Start processing chunks
                return processNextChunk(fileKey);
            })
            .catch(error => {
                processingInfo.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        Error: ${error.message}
                    </div>
                `;
            });
        });
        
        // Process file chunks
        function processNextChunk(fileKey) {
            return fetch('/import/generate-chunk', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ file_key: fileKey })
            })
            .then(response => {
                if (!response.ok) throw new Error('Processing failed');
                return response.json();
            })
            .then(data => {
                if (data.error) throw new Error(data.error);
                
                // Update progress
                const progress = Math.round((data.chunk_index + 1) / data.total_chunks * 100);
                processingProgress.style.width = `${progress}%`;
                processingProgress.textContent = `${progress}%`;
                processingStatus.textContent = `Processing file... (${data.chunk_index + 1}/${data.total_chunks} chunks)`;
                
                // Update results
                return updateResults(fileKey)
                    .then(() => {
                        // Continue processing or complete
                        if (!data.is_complete) {
                            return processNextChunk(fileKey);
                        } else {
                            processingStatus.textContent = 'Processing complete!';
                            processingInfo.innerHTML = `
                                <div class="alert alert-success">
                                    <i class="bi bi-check-circle me-2"></i>
                                    Generated ${generatedFlashcards.length} flashcards successfully!
                                </div>
                            `;
                            saveFlashcardsBtn.classList.remove('d-none');
                            return Promise.resolve();
                        }
                    });
            });
        }
        
        // Update flashcard results
        function updateResults(fileKey) {
            return fetch(`/import/all-file-flashcards?file_key=${fileKey}&format=mc`)
                .then(response => {
                    if (!response.ok) throw new Error('Failed to fetch flashcards');
                    return response.json();
                })
                .then(data => {
                    generatedFlashcards = data.mc_flashcards || [];
                    importResults.innerHTML = '';
                    
                    // Display a limited number of flashcards as preview
                    const previewLimit = Math.min(10, generatedFlashcards.length);
                    const preview = generatedFlashcards.slice(0, previewLimit);
                    
                    if (preview.length === 0) {
                        importResults.innerHTML = '<p class="text-muted">No flashcards generated yet...</p>';
                        return;
                    }
                    
                    const cardRows = [];
                    for (let i = 0; i < preview.length; i += 2) {
                        const row = document.createElement('div');
                        row.className = 'row g-3 mb-3';
                        
                        // First card in row
                        const card1 = previewCardHTML(preview[i], i);
                        row.innerHTML += card1;
                        
                        // Second card in row (if exists)
                        if (i + 1 < preview.length) {
                            const card2 = previewCardHTML(preview[i + 1], i + 1);
                            row.innerHTML += card2;
                        }
                        
                        cardRows.push(row);
                    }
                    
                    // Show preview and count message
                    const totalMessage = document.createElement('p');
                    totalMessage.className = 'alert alert-info';
                    totalMessage.innerHTML = `<i class="bi bi-info-circle me-2"></i> Showing ${previewLimit} of ${generatedFlashcards.length} flashcards generated`;
                    
                    importResults.appendChild(totalMessage);
                    cardRows.forEach(row => importResults.appendChild(row));
                });
        }
        
        // Generate HTML for preview card
        function previewCardHTML(card, index) {
            return `
                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-body">
                            <h5 class="card-title text-primary">
                                <i class="bi bi-question-circle"></i> ${card.q}
                            </h5>
                            <hr>
                            <p class="card-text">
                                <i class="bi bi-check-circle-fill text-success"></i> <strong>${card.ca}</strong>
                            </p>
                            <p class="card-text small text-muted">
                                <i class="bi bi-x-circle"></i> ${card.ia.join(', ')}
                            </p>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Save flashcards to deck
        saveFlashcardsBtn.addEventListener('click', function() {
            if (!fileKey || !deckSelector.value) {
                return;
            }
            
            this.disabled = true;
            this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...';
            
            fetch('/import/save-to-deck', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    file_key: fileKey,
                    deck_id: deckSelector.value
                })
            })
            .then(response => {
                if (!response.ok) throw new Error('Save failed');
                return response.json();
            })
            .then(data => {
                if (data.error) throw new Error(data.error);
                
                // Show success message
                processingInfo.innerHTML = `
                    <div class="alert alert-success">
                        <i class="bi bi-check-circle me-2"></i>
                        ${data.message || 'Flashcards saved successfully!'}
                    </div>
                `;
                
                // Close modal after delay
                setTimeout(() => {
                    const modalInstance = bootstrap.Modal.getInstance(document.getElementById('importContentModal'));
                    modalInstance.hide();
                    
                    // Refresh page or update deck list if needed
                    if (window.location.href.includes('/deck/')) {
                        window.location.reload();
                    }
                }, 2000);
            })
            .catch(error => {
                this.disabled = false;
                this.innerHTML = '<i class="bi bi-save"></i> Save Flashcards';
                
                processingInfo.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        Error: ${error.message}
                    </div>
                `;
            });
        });
    });
</script>
